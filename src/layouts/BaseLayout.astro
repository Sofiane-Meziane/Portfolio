---
import "../styles/global.css";
import { i18n, defaultLang, isLang } from "../lib/i18n";

const { title, description, lang: langProp } = Astro.props;
const lang = isLang(langProp) ? langProp : defaultLang;
const t = i18n[lang];

const pageTitle = title ?? `${t.siteName} | ${t.siteTitle}`;
const pageDescription = description ?? t.siteDescription;

const otherLang = lang === "en" ? "fr" : "en";
const path = Astro.url.pathname;
let switchHref = `/${otherLang}/`;
if (path === `/${lang}` || path === `/${lang}/`) {
  switchHref = `/${otherLang}/`;
} else if (path.startsWith(`/${lang}/`)) {
  switchHref = path.replace(`/${lang}/`, `/${otherLang}/`);
}

const nav = [
  { href: `/${lang}/`, label: t.navHome },
  { href: `/${lang}/projects`, label: t.navProjects },
  { href: "https://github.com/Sofiane-Meziane", label: t.navGitHub, external: true }
];
---
<!doctype html>
<html lang={lang} data-lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Spectral:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script is:inline>
      (function () {
        try {
          const stored = localStorage.getItem("theme");
          const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
          const theme = stored || (prefersDark ? "dark" : "light");
          document.documentElement.dataset.theme = theme;
        } catch (err) {
          // ignore
        }
      })();
    </script>
  </head>
  <body class="text-ink antialiased">
    <div class="relative min-h-screen overflow-hidden">
      <div class="pointer-events-none absolute inset-0">
        <div class="absolute -top-32 -left-24 h-80 w-80 rounded-full bg-sun/40 blur-3xl animate-float-slow"></div>
        <div class="absolute top-10 right-0 h-72 w-72 rounded-full bg-sea/30 blur-3xl"></div>
        <div class="absolute bottom-0 left-1/3 h-64 w-64 rounded-full bg-clay/25 blur-3xl"></div>
        <div class="absolute inset-0 grid-lines"></div>
      </div>

      <header class="relative z-10">
        <div class="mx-auto flex max-w-6xl items-center justify-between px-6 py-6">
          <a href={`/${lang}/`} class="font-display text-xl tracking-tight">{t.siteName}</a>
          <nav class="flex items-center gap-6 text-xs font-semibold uppercase tracking-[0.2em] text-ink/70">
            {nav.map((item) => (
              <a
                href={item.href}
                class="transition hover:text-ink"
                target={item.external ? "_blank" : undefined}
                rel={item.external ? "noreferrer" : undefined}
              >
                {item.label}
              </a>
            ))}
            <button
              type="button"
              class="theme-toggle"
              data-light-label={t.themeLightLabel}
              data-dark-label={t.themeDarkLabel}
              data-light-aria={t.themeLightAria}
              data-dark-aria={t.themeDarkAria}
            ></button>
            <a href={switchHref} class="lang-toggle" aria-label={t.toggleAria}>
              {t.toggleLabel}
            </a>
          </nav>
        </div>
      </header>

      <main class="relative z-10 mx-auto w-full max-w-6xl px-6 pb-20">
        <slot />
      </main>

      <footer class="relative z-10 border-t border-ink/10">
        <div class="mx-auto flex max-w-6xl flex-wrap items-center justify-between gap-4 px-6 py-6 text-sm text-ink/70">
          <span>{t.footerBuilt}</span>
          <span>{t.footerUpdated}</span>
        </div>
      </footer>
    </div>

    <script is:inline>
      try {
        localStorage.setItem("lang", {JSON.stringify(lang)});
      } catch (err) {
        // ignore
      }
    </script>
    <script is:inline>
      (function () {
        const root = document.documentElement;
        const button = document.querySelector(".theme-toggle");
        if (!button) return;
        const lightLabel = button.getAttribute("data-light-label") || "Light";
        const darkLabel = button.getAttribute("data-dark-label") || "Dark";
        const lightAria = button.getAttribute("data-light-aria") || "Switch to light mode";
        const darkAria = button.getAttribute("data-dark-aria") || "Switch to dark mode";

        const applyTheme = (theme) => {
          root.dataset.theme = theme;
          button.textContent = theme === "dark" ? lightLabel : darkLabel;
          button.setAttribute("aria-label", theme === "dark" ? lightAria : darkAria);
          button.setAttribute("data-theme", theme);
        };

        let stored = null;
        try {
          stored = localStorage.getItem("theme");
        } catch (err) {
          // ignore
        }

        if (!root.dataset.theme) {
          const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
          applyTheme(stored || (prefersDark ? "dark" : "light"));
        } else {
          applyTheme(root.dataset.theme);
        }

        button.addEventListener("click", () => {
          const next = root.dataset.theme === "dark" ? "light" : "dark";
          applyTheme(next);
          try {
            localStorage.setItem("theme", next);
          } catch (err) {
            // ignore
          }
        });
      })();
    </script>
  </body>
</html>